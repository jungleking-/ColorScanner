<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Photo color test</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link href="https://getbootstrap.com/docs/4.0/examples/checkout/form-validation.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container">
    <div>
      <div><img src="images/Color.jpeg" class="img-fluid rounded" /></div>
   </div>
   <div>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">RGB</th>
          <th scope="col">%</th>
        </tr>
      </thead>
      <tbody id="colorTableValues">
      </tbody>
    </table>
  </div>
    <p id="status">OpenCV.js is loading...</p>
    <p>閾値min: <input type="text" id="colorMin" value="5" size="5"/>  閾値max: <input type="text" id="colorMax" value="5" size="5" /> </p>

    <div>
      <div class="inputoutput">
        <img id="imageSrc" alt="No Image"  style="width:300px; display:none;" />
        <div class="caption"><input type="file" id="fileInput" name="file" /></div>
      </div>
      <div class="inputoutput">
        <canvas id="canvasOutput"  style="width:300px;"></canvas>
      </div>
    </div>

  <div>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">マッチピクセル数</th>
          <th scope="col">マッチ率</th>
        </tr>
      </thead>
      <tbody id="colorMatchValues">
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript">
let imgElement = document.getElementById('imageSrc');
let inputElement = document.getElementById('fileInput');

inputElement.addEventListener('change', (e) => {
  imgElement.src = URL.createObjectURL(e.target.files[0]);
}, false);

var colors = [
  getColor(255, 255, 255), // 0%
  getColor(191, 191, 188), // 10%
  getColor(177, 177, 177), // 20%
  getColor(163, 162, 169), // 30%
  getColor(153, 147, 163), // 40%
  getColor(120, 109, 123), // 50%
  getColor(162, 153, 169), // 60%
  getColor(145, 126, 136), // 70%
  getColor(119, 103, 133), // 80%
  getColor(110,  87, 118), // 90%
  getColor( 95,  67,  99), // 100%
];

var colorHTML = "";
for (var i = 0; i < colors.length; i++) {
  var colorCode = convert_to_color_code(colors[i].r, colors[i].g, colors[i].b);
   colorHTML += '<tr style="background-color: ' + colorCode + '">';
   colorHTML += '<th scope="row">' + (i) + '</th>';
   colorHTML += '<td><div class="text-left">' + colors[i].r + ', ' + colors[i].g + ', ' + colors[i].b + ' (' + colorCode + ')</div></td>';
   colorHTML += '<td><div class="text-end">' + i * 10 + '%' + '</div></td>';
   colorHTML += '</tr>';
}
document.getElementById("colorTableValues").innerHTML = colorHTML;

imgElement.onload = function() {
  srcMat = cv.imread(imgElement);
  cv.imshow('canvasOutput', srcMat);
  search();
};

function getColor(r, g, b) {
  var color = {
    r : 0,
    g : 0,
    b : 0
  };
  color.r = r;
  color.g = g;
  color.b = b;
  return color;
}

function convert_to_color_code(rDec, gDec, bDec) {
    var rHex = rDec.toString(16);
    rHex = ('00' + rHex).slice(-2);
    var gHex = gDec.toString(16);
    gHex = ('00' + gHex).slice(-2);
    var bHex = bDec.toString(16);
    bHex = ('00' + bHex).slice(-2);
    return '#' + rHex + gHex + bHex;
}
var colorCount = {};
for (var i = 0; i < colors.length; i++) {
  colorCount[i] = 0;
}

var search = function() {
  var canvas = document.getElementById('canvasOutput');
	var ctx = canvas.getContext('2d');

  var allColorMatchCount = 0;
  for (var x = 0; x < canvas.width; x++) {
    for (var y = 0; y < canvas.height; y++) {
      var imgData = ctx.getImageData(x, y, 1, 1);
      var rgba = imgData.data;
      for (var i = 0; i < colors.length; i++) {
        var color = colors[i];
        var min = 5; // document.getElementById("colorMin").value;
        var max = 5; // document.getElementById("colorMax").value;
        if (
          rgba[0] <= color.r + max && rgba[0] >= color.r - min &&
          rgba[1] <= color.g + max && rgba[1] >= color.g - min &&
          rgba[2] <= color.b + max && rgba[2] >= color.b - min
        ) {
          colorCount[i]++;
          allColorMatchCount++;
        }
      }
    }
  }

  var colorMatchHTML = "";
  for (var i = 0; i < colors.length; i++) {
    colorMatchHTML += '<tr>';
    colorMatchHTML += '<th scope="row">' + (i) + '</th>';
    colorMatchHTML += '<td><div class="text-end">' + colorCount[i] + '</div<</td>';
    colorMatchHTML += '<td><div class="text-end">' + Math.round(colorCount[i] / allColorMatchCount * 100 * 100) / 100 + '%' + '</div></td>';
    colorMatchHTML += '</tr>';
  }
  document.getElementById("colorMatchValues").innerHTML = colorMatchHTML;
  console.log(colorCount);
}

var Module = {
  onRuntimeInitialized() {
    document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
  }
};
</script>
<script async src="https://docs.opencv.org/3.4.0/opencv.js" type="text/javascript"></script>
</body>
</html>
